<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="format-detection" content="telephone=no" />
    <meta
      name="viewport"
      content="initial-scale=1.0,user-scalable=no,width=device-width,viewport-fit=cover"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title></title>
    <link rel="stylesheet" href="./css/animate.min.css" />
    <script>
      function getUrlParams(url) {
        // 如果没有传入URL，就使用当前页面的URL
        const urlString = url || window.location.href;
        let paramString = urlString.split('?')[1];
        const searchParams = new URLSearchParams(paramString);

        let paramObj = {};
        for (let pair of searchParams.entries()) {
          // 如果参数出现多次，使用数组存储所有值
          if (paramObj.hasOwnProperty(pair[0])) {
            if (Array.isArray(paramObj[pair[0]])) {
              paramObj[pair[0]].push(pair[1]);
            } else {
              paramObj[pair[0]] = [paramObj[pair[0]], pair[1]];
            }
          } else {
            paramObj[pair[0]] = pair[1];
          }
        }

        return paramObj;
      }

      function getPbFilterParams(url, fields) {
        const urlString = url;
        let paramString = urlString.split('?')[1];
        const searchParams = new URLSearchParams(paramString);

        let paramObj = {};
        for (let pair of searchParams.entries()) {
          if (pair[0].indexOf('pbf_') !== 0 && pair[0].indexOf('pbx_') !== 0) {
            continue;
          }

          if (pair[0].indexOf('pbf_') == 0) {
            pair[0] = pair[0].substring(4);

            if (pair[0] === 'keyword' && fields && fields.length > 0) {
              const keywordConditions = fields.map(
                field => `${field}~'${pair[1]}'`
              );
              paramObj[pair[0]] = `(${keywordConditions.join(' || ')})`;
            } else if (paramObj.hasOwnProperty(pair[0])) {
              if (Array.isArray(paramObj[pair[0]])) {
                paramObj[pair[0]].push(pair[1]);
              } else {
                paramObj[pair[0]] = [paramObj[pair[0]], pair[1]];
              }
            } else {
              paramObj[pair[0]] = pair[1];
            }
          } else if (pair[0].indexOf('pbx_') == 0) {
            const fname = pair[0].substring(4);
            const start_end = pair[1].split(',');

            if (
              start_end.length > 1 &&
              start_end[0].length > 0 &&
              start_end[1].length > 0
            ) {
              paramObj[
                pair[0]
              ] = `(${fname}>='${start_end[0]}'&&${fname}<='${start_end[1]}')`;
            }
          }
        }

        return paramObj;
      }

      function buildKeywordFilter(url, fields) {
        const filter = buildPocketBaseFilter(getPbFilterParams(url, fields));
        if (!filter) return url;

        const urlParts = url.split('?');
        const basePath = urlParts[0];
        const queryString = urlParts[1] || '';
        const searchParams = new URLSearchParams(queryString);

        if (searchParams.has('filter')) {
          const existingFilter = searchParams.get('filter');
          searchParams.set(
            'filter',
            existingFilter ? `${existingFilter} && ${filter}` : filter
          );
        } else {
          searchParams.set('filter', filter);
        }

        const newQueryString = searchParams.toString();
        return basePath + (newQueryString ? '?' + newQueryString : '');
      }

      function buildPocketBaseFilter(params) {
        const filters = [];
        for (const [key, value] of Object.entries(params)) {
          if (value !== undefined && value !== null && value !== '') {
            if (key == 'keyword') {
              filters.push(`${value}`);
            } else if (key.startsWith('pbx_')) {
              filters.push(`${value}`);
            } else if (
              typeof value === 'boolean' ||
              value === 'true' ||
              value === 'false'
            ) {
              filters.push(`${key}=${value}`);
            } else if (typeof value === 'string') {
              filters.push(`${key}~'${value}'`);
            } else if (typeof value === 'number') {
              filters.push(`${key}=${value}`);
            }
          }
        }
        return filters.length > 0 ? `(${filters.join(' && ')})` : '';
      }

      function getAuthToken() {
        const pb_admin_token = localStorage.getItem('pb_admin_auth');
        if (pb_admin_token) {
          try {
            return JSON.parse(pb_admin_token).token;
          } catch {}
        }

        const pocketbase_auth = localStorage.getItem('pocketbase_auth');
        if (pocketbase_auth) {
          try {
            return JSON.parse(pocketbase_auth).token;
          } catch {}
        }

        const pb_token = localStorage.getItem('pb_token');
        if (pb_token) {
          return pb_token;
        }

        return null;
      }

      function buildForest(items) {
        const nodeMap = new Map(items.map(item => [item.id, {...item}]));
        const roots = items.filter(item => !item.pid || !nodeMap.has(item.pid));

        for (const item of nodeMap.values()) {
          if (item.pid && nodeMap.has(item.pid)) {
            const parent = nodeMap.get(item.pid);
            if (!parent.children) {
              parent.children = [];
            }
            parent.children.push(item);
            if (parent.children[0].sort !== undefined) {
              parent.children.sort((a, b) => a.sort - b.sort);
            }
          }
        }

        if (roots[0]?.sort !== undefined) {
          roots.sort((a, b) => a.sort - b.sort);
        }

        return roots.map(root => nodeMap.get(root.id));
      }

      function hasPermission(requiredPermissions, requireAll) {
        const storedPermissions = localStorage.getItem('pb_permissions');
        if (!storedPermissions) return false;

        const userPermissions = JSON.parse(storedPermissions);

        if (requireAll) {
          // 需要拥有所有权限
          return requiredPermissions.every(permission =>
            userPermissions.includes(permission)
          );
        } else {
          // 拥有其中一个权限即可
          return requiredPermissions.some(permission =>
            userPermissions.includes(permission)
          );
        }
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
